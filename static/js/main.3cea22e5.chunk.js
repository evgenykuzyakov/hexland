(this.webpackJsonpfrontend=this.webpackJsonpfrontend||[]).push([[0],{121:function(e,t,n){},122:function(e,t,n){},125:function(e,t){},130:function(e,t){},146:function(e,t){},148:function(e,t){},173:function(e,t,n){"use strict";n.r(t);var a=n(1),r=n.n(a),i=n(85),c=n.n(i),s=(n(93),n(0)),o=n.n(s),u=n(8),l=n(34),h=n(35),d=n(87),f=n(86),v=(n(51),n(110),n(120),n(121),n(122),n(26)),p=n(25),m=n.n(p),b=n(36),g=n(10),x=n(12),w=n.n(x),y={},_=Math.pow(16,5),k=_/2,S=_/2,C={level:3,x:k/Math.pow(16,4),y:S/Math.pow(16,4)},E=w()(10).pow(23),O=w()(100).mul(w()(10).pow(12)).toFixed(0),R=function(e){return"#".concat((16777215&e).toString(16).padStart(6,"0"))},j=function(e){return JSON.stringify(e)},I=function(e){return{x:Math.trunc(e.x/16),y:Math.trunc(e.y/16),level:0}},A=function(e){return"".concat(D.contractName,":v01:-cell-").concat(e)},N=function(){function e(t,n,a){Object(l.a)(this,e),this.contract=t,this.setState=t.setState,this.refreshAllowance=t.refreshAllowance,this.state=t.state,this.ctx=n,this.redraw=a,this.pixelQueue=[],this.pendingPixels=[],this.pending={},this.sendQueueTimer=null,this.numFailedTxs=0,this.needRedraw=!1,this.renderLocal()}return Object(h.a)(e,[{key:"fetchCells",value:function(){var e=Object(u.a)(o.a.mark((function e(t){var n;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.contract.get_cells_json({cell_ids:t});case 2:return n=e.sent,e.abrupt("return",t.reduce((function(e,t,a){return e[j(t)]=n[a],e}),{}));case 4:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"getCell",value:function(e){var t=j(e);return t in y?y[t]:y[t]=m.a.get(A(t))||{nonce:0,colors:new Array(256).fill(0)}}},{key:"setCell",value:function(e,t){var n=j(e);y[n]=t,m.a.set(A(n),t)}},{key:"internalPaint",value:function(e,t){if(!(j(e)in y)){var n=Math.pow(16,e.level+1),a=e.x*n-k,r=e.y*n-S;this.ctx.fillStyle=R(t||3355443),this.ctx.fillRect(a,r,n,n),this.needRedraw=!0}}},{key:"internalRender",value:function(e,t){for(var n=this.ctx.createImageData(16,16),a=n.data,r=0,i=0;i<16;++i)for(var c=0;c<16;++c){var s=16*i+c,o=t.colors[s];a[r++]=o>>16&255,a[r++]=o>>8&255,a[r++]=255&o,a[r++]=255}var u=Math.pow(16,e.level+1),l=e.x*u-k,h=e.y*u-S;this.ctx.putImageData(n,l,h),this.needRedraw=!0}},{key:"internalRedraw",value:function(){this.needRedraw&&(this.needRedraw=!1,this.redraw())}},{key:"renderLocal",value:function(){for(var e=[C];e.length>0;){var t=e.splice(0,1)[0],n=this.getCell(t);if(n.nonce>0)if(0===t.level)this.internalRender(t,n);else for(var a=0;a<16;++a)for(var r=0;r<16;++r){var i=16*a+r,c={level:t.level-1,x:16*t.x+r,y:16*t.y+a};this.internalPaint(c,n.colors[i]),n.colors[i]&&e.push(c)}}this.internalRedraw()}},{key:"refreshAccountBalance",value:function(){var e=Object(u.a)(o.a.mark((function e(){var t;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.t0=w.a,e.next=3,this.contract.get_storage_balance({account_id:this.contract.account.accountId});case 3:if(e.t1=e.sent,e.t1){e.next=6;break}e.t1="0";case 6:return e.t2=e.t1,t=(0,e.t0)(e.t2),this.setState({accountBalance:t}),e.abrupt("return",t);case 10:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"sendQueue",value:function(){var e=Object(u.a)(o.a.mark((function e(){var t,n,a=this;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.pixelQueue.sort((function(e,t){return j(I(e)).localeCompare(j(I(t)))})),t=this.pixelQueue.splice(0,100),this.pendingPixels=t,e.next=5,this.refreshAccountBalance();case 5:return n=e.sent,e.prev=6,e.next=9,this.contract.draw_json({pixels:t},O,n.lt(E)?"1000000000000000000000000":"0");case 9:this.numFailedTxs=0,e.next=22;break;case 12:if(e.prev=12,e.t0=e.catch(6),-1===e.t0.toString().indexOf("does not have enough balance")){e.next=19;break}return e.next=18,this.refreshAllowance();case 18:return e.abrupt("return");case 19:console.log("Failed to send a transaction",e.t0),this.numFailedTxs+=1,this.numFailedTxs<3?(this.pixelQueue=this.pixelQueue.concat(this.pendingPixels),this.pendingPixels=[]):(this.pendingPixels=[],this.pixelQueue=[]);case 22:return e.prev=22,e.next=25,this.refreshAccountBalance();case 25:e.next=29;break;case 27:e.prev=27,e.t1=e.catch(22);case 29:this.pendingPixels.forEach((function(e){return delete a.pending[j(e)]})),this.pendingPixels=[];case 31:case"end":return e.stop()}}),e,this,[[6,12],[22,27]])})));return function(){return e.apply(this,arguments)}}()},{key:"pingQueue",value:function(){var e=Object(u.a)(o.a.mark((function e(t){var n=this;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.sendQueueTimer&&(clearTimeout(this.sendQueueTimer),this.sendQueueTimer=null),0!==this.pendingPixels.length||!(this.pixelQueue.length>=100||t)){e.next=4;break}return e.next=4,this.sendQueue();case 4:this.pixelQueue.length>0&&(this.sendQueueTimer=setTimeout(Object(u.a)(o.a.mark((function e(){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,n.pingQueue(!0);case 2:case"end":return e.stop()}}),e)}))),250));case 5:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"modifyPixel",value:function(e){var t=this,n=I(e),a=this.getCell(n),r=16*(e.y-16*n.y)+e.x-16*n.x;a.colors[r]=e.c;var i=e.x-k,c=e.y-S;this.ctx.fillStyle=R(e.c),this.ctx.fillRect(i,c,1,1),this.needRedraw=!0,setTimeout((function(){t.internalRedraw()}),100)}},{key:"draw",value:function(e){var t=function(e){return parseInt(e.substring(1),16)}(this.state.color),n={x:k+e.a,y:S+e.b,c:t},a=j(n);a in this.pending||(this.pending[a]=!0,this.pixelQueue.push(n),this.modifyPixel(n)),this.pingQueue(!1)}},{key:"refreshCells",value:function(){var e=Object(u.a)(o.a.mark((function e(){var t,n,a,r=this;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t=[C];case 1:if(!(t.length>0)){e.next=10;break}return n=t.splice(0,16),e.next=5,this.fetchCells(n);case 5:a=e.sent,Object.entries(a).forEach((function(e){var n,a=Object(b.a)(e,2),i=a[0],c=a[1];if(c){if(n=i,0===(i=JSON.parse(n)).level)r.internalRender(i,c);else{var s=r.getCell(i);if(c.nonce!==s.nonce)for(var o=0;o<16;++o)for(var u=0;u<16;++u){var l=16*o+u,h={level:i.level-1,x:16*i.x+u,y:16*i.y+o};r.internalPaint(h,c.colors[l]),c.colors[l]!==s.colors[l]&&t.push(h)}}r.setCell(i,c)}})),this.internalRedraw(),e.next=1;break;case 10:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()}]),e}(),z=Math.sqrt(3)/2,P=2*z,q=z,B=null,Q=!1,T={a:0,b:0,zoom:1,aspect:1};function F(e,t){var n=t/1.5;return{a:(e-n*q)/P,b:n}}var M=function(e){var t=Object(a.useRef)(null),n=e._near.contract,i=Object(a.useState)(null),c=Object(b.a)(i,2),s=c[0],l=c[1];n&&(n.setState=e.setState,n.refreshAllowance=e.refreshAllowance,s&&(s.state=e.state));var h=e.state.draw;return Object(a.useEffect)((function(){Q=h}),[h]),Object(a.useEffect)((function(){if(t.current&&n){console.log("Setup");var e=t.current.getContext("webgl"),a=function(){var e=Object(u.a)(o.a.mark((function e(t){var n,a,i,c,s,u,l,h,d,f,v,p;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:for(i=function(e,t){var r=1.5*(t-a)+0*(e-n),i=(t-a)*q+(e-n)*P;return i*i+r*r},n=2048*(T.a+t.a/T.zoom+.5)-.5,a=2048*(T.b+t.b/T.zoom+.5)-.5,c=Math.trunc(n),s=Math.trunc(a),u=null,l=10,h=-1;h<2;++h)for(d=-1;d<2;++d)(p=i(f=c+h,v=s+d))<l+1e-9&&(u={a:f,b:v},l=p);r.draw(u);case 9:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),r=function(e,t){var n=g.createProgramInfo(t,["\nconst float Sq3 = sqrt(3.0) / 2.0;\nconst mat2 D = mat2(Sq3 * 2.0, Sq3, 0.0, -1.5);\n\nuniform vec2 resolution;\nuniform vec3 pos;\n\nattribute vec4 a_position;\nattribute vec2 a_texcoord;\nattribute vec2 a_ab;\n\nvarying vec2 v_texCoord;\nvarying vec2 v_ab;\n\nvoid main() {\n  gl_Position = vec4((a_position.xy - pos.xy * D) * vec2(2.0, 2.0 * resolution.x / resolution.y) * pos.z, a_position.zw);\n  v_texCoord = a_texcoord;\n  v_ab = a_ab;\n}\n","\nprecision highp float;\n\nconst float Sq3 = sqrt(3.0) / 2.0;\nconst mat2 D = mat2(Sq3 * 2.0, Sq3, 0.0, -1.5);\n\nuniform vec3 color;\nuniform sampler2D u_diffuse;\nuniform vec2 texSize;\n\nvarying vec2 v_texCoord;\nvarying vec2 v_ab;\n\nfloat d(vec2 p) {\n  vec2 dx = (p - v_ab) * D;\n  return dot(dx, dx);\n}\n\nvec3 mind(vec3 a, vec2 b)\n{\n  float db = d(b); \n  return mix(vec3(b, db), a, step(a.z, db));\n}\n\nvoid main() {\n  vec2 fab = floor(v_ab);\n  vec3 best = vec3(fab, d(fab));\n  best = mind(best, fab + vec2(1.0, 0.0));\n  best = mind(best, fab + vec2(0.0, 1.0));\n  best = mind(best, fab + vec2(1.0, 1.0));\n  \n  vec4 diffuseColor = texture2D(u_diffuse, best.xy / texSize);\n  if (diffuseColor.w < 1.0) {\n    discard;\n  }\n  gl_FragColor = diffuseColor;\n}\n"]),a={a_position:[-z-z/2,.75,0,z-z/2,.75,0,0-z/2,-.75,0,z-z/2,.75,0,2*z-z/2,-.75,0,0-z/2,-.75,0],a_texcoord:[0,0,1,0,0,1,1,0,1,1,0,1],a_ab:{numComponents:2,data:[-.5,-.5,2047.5,-.5,-.5,2047.5,2047.5,-.5,2047.5,2047.5,-.5,2047.5]}},r=g.createBufferInfoFromArrays(t,a),i=document.createElement("canvas");i.width=2048,i.height=2048;var c=i.getContext("2d");c.clearRect(0,0,2048,2048);var s=g.createTextures(t,{fromCanvas:{src:i,mag:t.NEAREST,min:t.NEAREST,wrap:t.CLAMP_TO_EDGE}}),o=new N(e,c,(function(){c.fillStyle="rgba(0, 0, 0, 0)",c.fillRect(0,0,1,1),g.setTextureFromElement(t,s.fromCanvas,i)}));return o.refreshCells(),setInterval((function(){o.refreshCells()}),5e3),requestAnimationFrame((function e(a){g.resizeCanvasToDisplaySize(t.canvas),g.bindFramebufferInfo(t,null),t.viewport(0,0,t.canvas.width,t.canvas.height);var i={resolution:[t.canvas.width,t.canvas.height],texSize:[2047,2047],pos:[T.a,T.b,T.zoom],u_diffuse:s.fromCanvas};t.useProgram(n.program),g.setBuffersAndAttributes(t,n,r),g.setUniforms(n,i),g.drawBufferInfo(t,r),requestAnimationFrame(e)})),o}(n,e);l(r),t.current.addEventListener("mousemove",(function(e){var t=e.clientX,n=e.clientY,r=e.target.getBoundingClientRect(),i=F((t-r.x)/r.width-.5,(n-r.y)/r.width-r.height/r.width*.5);if(1&e.buttons&&Q)a(i);else if(B&&!Q){var c=F((t-B.x)/r.width,(n-B.y)/r.width),s=c.a,o=c.b;T={a:T.a-s/T.zoom,b:T.b-o/T.zoom,zoom:T.zoom,aspect:T.aspect}}B=1&e.buttons?{x:t,y:n}:null})),t.current.addEventListener("mousedown",(function(e){if(1&e.buttons&&Q){var t=e.clientX,n=e.clientY,r=e.target.getBoundingClientRect(),i=(t-r.x)/r.width-.5,c=(n-r.y)/r.width-r.height/r.width*.5;a(F(i,c))}})),t.current.addEventListener("wheel",(function(e){e.preventDefault();var t=e.target.getBoundingClientRect(),n=(e.clientX-t.x)/t.width-.5,a=((e.clientY-t.y)/t.width-t.height/t.width*.5)/1.5,r=(n-a*q)/P,i=Math.max(1/64,T.zoom*Math.exp(.001*-e.deltaY)),c=T.a+r/T.zoom,s=T.b+a/T.zoom;T={a:c-r/i,b:s-a/i,zoom:i,aspect:T.aspect}}));var i=function(){var n=(window.devicePixelRatio||1)/(e.webkitBackingStorePixelRatio||e.mozBackingStorePixelRatio||e.msBackingStorePixelRatio||e.oBackingStorePixelRatio||e.backingStorePixelRatio||1),a=window.innerWidth||document.documentElement.clientWidth||document.body.clientWidth,r=window.innerHeight||document.documentElement.clientHeight||document.body.clientHeight;t.current.width=a*n,t.current.height=r*n,T=Object.assign({},T,{aspect:r/a})};window.addEventListener("resize",i),i()}}),[t,n]),r.a.createElement("div",null,r.a.createElement("canvas",{ref:t,className:"canvas",width:640}))},D={networkId:"testnet",nodeUrl:"https://rpc.testnet.near.org",archivalNodeUrl:"https://rpc.mainnet.internal.near.org",contractName:"dev-1633114897352-65032726804099",walletUrl:"https://wallet.testnet.near.org"},L=function(e){Object(d.a)(n,e);var t=Object(f.a)(n);function n(e){var a;return Object(l.a)(this,n),(a=t.call(this,e))._near={},a.state={connected:!1,draw:!1,isNavCollapsed:!0,account:null,accountBalance:w()(0),color:"#".concat(Math.trunc(16777215*Math.random()).toString(16).padStart(6,"0"))},a._initNear().then((function(){a.setState({signedIn:!!a._near.accountId,signedAccountId:a._near.accountId,connected:!0})})),a}return Object(h.a)(n,[{key:"_initNear",value:function(){var e=Object(u.a)(o.a.mark((function e(){var t,n,a;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=new v.keyStores.BrowserLocalStorageKeyStore,e.next=3,v.connect(Object.assign({deps:{keyStore:t}},D));case 3:if(n=e.sent,this._near.keyStore=t,this._near.near=n,this._near.walletConnection=new v.WalletConnection(n,D.contractName),this._near.accountId=this._near.walletConnection.getAccountId(),this._near.account=this._near.walletConnection.account(),this._near.contract=new v.Contract(this._near.account,D.contractName,{viewMethods:["get_cells_json","get_storage_balance"],changeMethods:["draw_json"]}),!this._near.accountId){e.next=20;break}return e.t0=w.a,e.next=14,this._near.contract.get_storage_balance({account_id:this._near.accountId});case 14:if(e.t1=e.sent,e.t1){e.next=17;break}e.t1="0";case 17:e.t2=e.t1,a=(0,e.t0)(e.t2),this.setState({accountBalance:a});case 20:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"requestSignIn",value:function(){var e=Object(u.a)(o.a.mark((function e(t){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t&&t.preventDefault(),"",e.next=4,this._near.walletConnection.requestSignIn(D.contractName,"");case 4:return e.abrupt("return",!1);case 5:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"logOut",value:function(){var e=Object(u.a)(o.a.mark((function e(){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:this._near.walletConnection.signOut(),this._near.accountId=null,this.setState({signedIn:!!this._accountId,signedAccountId:this._accountId});case 3:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"popRequest",value:function(e){var t=this.state.requests.slice(1);this.setState({requests:t},e)}},{key:"addRequest",value:function(e,t){var n=this.state.requests.slice(0);n.push(e),this.setState({requests:n},t)}},{key:"addRecentCard",value:function(e){var t=this.state.recentCards.slice(0),n=t.indexOf(e);-1!==n&&t.splice(n,1),t.unshift(e),t=t.slice(0,5),m.a.set(this._near.lsKeyRecentCards,t),this.setState({recentCards:t})}},{key:"refreshAllowance",value:function(){var e=Object(u.a)(o.a.mark((function e(){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return alert("You're out of access key allowance. Need sign in again to refresh it"),e.next=3,this.logOut();case 3:return e.next=5,this.requestSignIn();case 5:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"render",value:function(){var e=this,t={_near:this._near,setState:function(t,n){return e.setState(t,n)},refreshAllowance:function(){return e.refreshAllowance()},state:this.state},n=this.state.connected?this.state.signedIn?r.a.createElement("div",null,r.a.createElement("button",{className:"btn btn-primary me-2",onClick:function(){return e.setState({draw:!e.state.draw})}},this.state.draw?"Draw mode":"Scroll mode"),this.state.draw&&r.a.createElement(r.a.Fragment,null,"Color:",r.a.createElement("div",{className:"d-inline-block align-middle"},r.a.createElement("input",{className:"form-control ms-2 p-0",type:"color",id:"color",name:"color",style:{minWidth:"5em"},value:this.state.color,onChange:function(t){return e.setState({color:t.target.value})}}))),r.a.createElement("div",{style:{float:"right"}},r.a.createElement("label",null,"Account Balance: ",this.state.accountBalance.div(w()(10).pow(24)).toFixed(3)," NEAR"),r.a.createElement("button",{className:"btn btn-outline-secondary ms-2",onClick:function(){return e.logOut()}},"Sign out (",this.state.signedAccountId,")"))):r.a.createElement("div",null,r.a.createElement("button",{className:"btn btn-primary",onClick:function(t){return e.requestSignIn(t)}},"Sign in with NEAR Wallet")):r.a.createElement("div",null,"Connecting... ",r.a.createElement("span",{className:"spinner-grow spinner-grow-sm",role:"status","aria-hidden":"true"}));return r.a.createElement("div",{className:"App"},n,r.a.createElement("a",{className:"github-fork-ribbon right-bottom fixed",href:"https://github.com/evgenykuzyakov/hexland","data-ribbon":"Fork me on GitHub",title:"Fork me on GitHub"},"Fork me on GitHub"),r.a.createElement(M,t))}}]),n}(r.a.Component);c.a.render(r.a.createElement(L,null),document.getElementById("root"))},88:function(e,t,n){e.exports=n(173)},93:function(e,t,n){}},[[88,1,2]]]);
//# sourceMappingURL=main.3cea22e5.chunk.js.map