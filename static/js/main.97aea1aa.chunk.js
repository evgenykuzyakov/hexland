(this.webpackJsonpfrontend=this.webpackJsonpfrontend||[]).push([[0],{110:function(e,t,n){},111:function(e,t,n){},116:function(e,t){},124:function(e,t){},140:function(e,t){},142:function(e,t){},171:function(e,t,n){"use strict";n.r(t);var a=n(1),r=n.n(a),o=n(84),c=n.n(o),i=(n(93),n(86)),s=n(0),u=n.n(s),l=n(9),d=n(32),f=n(33),h=n(87),v=n(85),b=(n(47),n(110),n(111),n(15)),p=n(45),m=n.n(p),g=n(19),w=n(10),y={},x=Math.pow(16,5),_=x/2,C=x/2,k={level:3,x:_/Math.pow(16,4),y:C/Math.pow(16,4)},S=function(e){return JSON.stringify(e)},O=function(){function e(t,n,a){Object(d.a)(this,e),this.contract=t,this.ctx=n,this.redraw=a,this.needRedraw=!1}return Object(f.a)(e,[{key:"fetchCells",value:function(){var e=Object(l.a)(u.a.mark((function e(t){var n;return u.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.contract.get_cells_json({cell_ids:t});case 2:return n=e.sent,e.abrupt("return",t.reduce((function(e,t,a){return e[S(t)]=n[a],e}),{}));case 4:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"getCell",value:function(e){var t=S(e);return t in y?y[t]:{nonce:0,colors:new Array(256).fill(0)}}},{key:"setCell",value:function(e,t){y[S(e)]=t}},{key:"internalPaint",value:function(e,t){if(!(S(e)in y)){var n=Math.pow(16,e.level+1),a=e.x*n-_,r=e.y*n-C;this.ctx.fillStyle="#".concat((16777215&t).toString(16).padStart(6,"0")),this.ctx.fillRect(a,r,n,n),this.needRedraw=!0}}},{key:"internalRender",value:function(e,t){for(var n=this.ctx.createImageData(16,16),a=n.data,r=0,o=0;o<16;++o)for(var c=0;c<16;++c){var i=16*o+c,s=t.colors[i];a[r++]=s>>16&255,a[r++]=s>>8&255,a[r++]=255&s,a[r++]=255}var u=Math.pow(16,e.level+1),l=e.x*u-_,d=e.y*u-C;this.ctx.putImageData(n,l,d),this.needRedraw=!0}},{key:"internalRedraw",value:function(){this.needRedraw&&(this.needRedraw=!1,this.redraw())}},{key:"refreshCells",value:function(){var e=Object(l.a)(u.a.mark((function e(){var t,n,a,r=this;return u.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t=[k];case 1:if(!(t.length>0)){e.next=10;break}return n=t.splice(0,16),e.next=5,this.fetchCells(n);case 5:a=e.sent,Object.entries(a).forEach((function(e){var n,a=Object(g.a)(e,2),o=a[0],c=a[1];if(c){if(n=o,o=JSON.parse(n),console.log(o,c),0===o.level)r.internalRender(o,c);else{var i=r.getCell(o);if(c.nonce!==i.nonce)for(var s=0;s<16;++s)for(var u=0;u<16;++u){var l=16*s+u;if(c.colors[l]!==i.colors[l]){var d={level:o.level-1,x:16*o.x+u,y:16*o.y+s};r.internalPaint(d,c.colors[l]),t.push(d)}}}r.setCell(o,c)}})),this.internalRedraw(),e.next=1;break;case 10:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()}]),e}(),R=Math.sqrt(3)/2,j=2*R,E=R,I=null,q=!1,z={a:0,b:0,zoom:1,aspect:1},N={pos:[0,0,1]};function A(e,t){var n=t/1.5;return{a:(e-n*E)/j,b:n}}var M=function(e){var t=Object(a.useRef)(null),n=Object(a.useState)(null),o=Object(g.a)(n,2),c=o[0],i=o[1],s=Object(a.useState)(z),d=Object(g.a)(s,2),f=d[0],h=d[1],v=Object(a.useState)({a:0,b:0}),b=Object(g.a)(v,2),p=b[0],m=b[1],y=Object(a.useCallback)((function(){var e=f.aspect,t=f.zoom,n=e/t/1.5/2,a=(1/t/2-n*E)/j;f.a,f.b;Object.assign(N,{pos:[f.a,f.b,t]})}),[c,f,p]);Object(a.useEffect)((function(){c&&y()}),[p,f,c,y]);var x=e._near.contract,k=e.draw;return Object(a.useEffect)((function(){q=k}),[k]),Object(a.useEffect)((function(){if(t.current&&x){console.log("Setup");var e=t.current.getContext("webgl");i(e),function(e,t){var n=w.createProgramInfo(t,["\nconst float Sq3 = sqrt(3.0) / 2.0;\nconst mat2 D = mat2(Sq3 * 2.0, Sq3, 0.0, -1.5);\n\nuniform vec2 resolution;\nuniform vec3 pos;\n\nattribute vec4 a_position;\nattribute vec2 a_texcoord;\nattribute vec2 a_ab;\n\nvarying vec2 v_texCoord;\nvarying vec2 v_ab;\n\nvoid main() {\n  gl_Position = vec4((a_position.xy - pos.xy * D) * vec2(2.0, 2.0 * resolution.x / resolution.y) * pos.z, a_position.zw);\n  v_texCoord = a_texcoord;\n  v_ab = a_ab;\n}\n","\nprecision highp float;\n\nconst float Sq3 = sqrt(3.0) / 2.0;\nconst mat2 D = mat2(Sq3 * 2.0, Sq3, 0.0, -1.5);\n\nuniform vec3 color;\nuniform sampler2D u_diffuse;\nuniform vec2 texSize;\n\nvarying vec2 v_texCoord;\nvarying vec2 v_ab;\n\nfloat d(vec2 p) {\n  vec2 dx = (p - v_ab) * D;\n  return dot(dx, dx);\n}\n\nvec3 mind(vec3 a, vec2 b)\n{\n  float db = d(b); \n  return mix(vec3(b, db), a, step(a.z, db));\n}\n\nvoid main() {\n  vec2 fab = floor(v_ab);\n  vec3 best = vec3(fab, d(fab));\n  best = mind(best, fab + vec2(1.0, 0.0));\n  best = mind(best, fab + vec2(0.0, 1.0));\n  best = mind(best, fab + vec2(1.0, 1.0));\n  \n  vec4 diffuseColor = texture2D(u_diffuse, best.xy / texSize);\n  if (diffuseColor.w < 1.0) {\n    discard;\n  }\n  gl_FragColor = diffuseColor;\n}\n"]),a={a_position:[-R-R/2,.75,0,R-R/2,.75,0,0-R/2,-.75,0,R-R/2,.75,0,2*R-R/2,-.75,0,0-R/2,-.75,0],a_texcoord:[0,0,1,0,0,1,1,0,1,1,0,1],a_ab:{numComponents:2,data:[-.5,-.5,2047.5,-.5,-.5,2047.5,2047.5,-.5,2047.5,2047.5,-.5,2047.5]}},r=w.createBufferInfoFromArrays(t,a),o=document.createElement("canvas");o.width=2048,o.height=2048;var c=o.getContext("2d");c.clearRect(0,0,2048,2048);var i=w.createTextures(t,{fromCanvas:{src:o,mag:t.NEAREST,min:t.NEAREST,wrap:t.CLAMP_TO_EDGE}}),s=new O(e,c,(function(){c.fillStyle="rgba(0, 0, 0, 0)",c.fillRect(0,0,1,1),w.setTextureFromElement(t,i.fromCanvas,o)}));s.refreshCells(),setInterval((function(){s.refreshCells()}),5e3),requestAnimationFrame((function e(a){w.resizeCanvasToDisplaySize(t.canvas),w.bindFramebufferInfo(t,null),t.viewport(0,0,t.canvas.width,t.canvas.height);var o={resolution:[t.canvas.width,t.canvas.height],texSize:[2047,2047],pos:N.pos,u_diffuse:i.fromCanvas};t.useProgram(n.program),w.setBuffersAndAttributes(t,n,r),w.setUniforms(n,o),w.drawBufferInfo(t,r),requestAnimationFrame(e)}))}(x,e),t.current.addEventListener("mousemove",(function(e){var t=e.clientX,n=e.clientY,a=e.target.getBoundingClientRect(),r=(t-a.x)/a.width-.5,o=(n-a.y)/a.width-a.height/a.width*.5;if(m(A(r,o)),I&&!q){var c=A((t-I.x)/a.width,(n-I.y)/a.width),i=c.a,s=c.b;h((function(e){return z={a:e.a-i/e.zoom,b:e.b-s/e.zoom,zoom:e.zoom,aspect:e.aspect}}))}I=1&e.buttons?{x:t,y:n}:null}));var n=function(){var e=Object(l.a)(u.a.mark((function e(t){var n,a,r,o,c,i,s,l,d,f,h,v,b,p;return u.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:for(o=function(e,t){var n=1.5*(t-r)+0*(e-a),o=(t-r)*E+(e-a)*j;return o*o+n*n},a=2048*((n=z).a+t.a/n.zoom+.5)-.5,r=2048*(n.b+t.b/n.zoom+.5)-.5,c=Math.trunc(a),i=Math.trunc(r),s=null,l=10,d=-1;d<2;++d)for(f=-1;f<2;++f)(b=o(h=c+d,v=i+f))<l+1e-9&&(s={a:h,b:v},l=b);return console.log(s),e.next=12,x.get_storage_balance({account_id:x.account.accountId});case 12:if(e.t0=e.sent,e.t0){e.next=15;break}e.t0="0";case 15:return p=e.t0,e.next=18,x.draw_json({pixels:[{x:_+s.a,y:C+s.b,c:16777215}]},"30000000000000",p.length<=24?"2000000000000000000000000":"0");case 18:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}();t.current.addEventListener("mousedown",(function(e){if(1&e.buttons&&q){var t=e.clientX,a=e.clientY,r=e.target.getBoundingClientRect(),o=(t-r.x)/r.width-.5,c=(a-r.y)/r.width-r.height/r.width*.5;n(A(o,c))}})),t.current.addEventListener("wheel",(function(e){e.preventDefault();var t=e.target.getBoundingClientRect(),n=(e.clientX-t.x)/t.width-.5,a=((e.clientY-t.y)/t.width-t.height/t.width*.5)/1.5,r=(n-a*E)/j;h((function(t){var n=Math.max(1/64,t.zoom*Math.exp(.001*-e.deltaY)),o=t.a+r/t.zoom,c=t.b+a/t.zoom;return z={a:o-r/n,b:c-a/n,zoom:n,aspect:t.aspect}}))}));var a=function(){var n=(window.devicePixelRatio||1)/(e.webkitBackingStorePixelRatio||e.mozBackingStorePixelRatio||e.msBackingStorePixelRatio||e.oBackingStorePixelRatio||e.backingStorePixelRatio||1),a=window.innerWidth||document.documentElement.clientWidth||document.body.clientWidth,r=window.innerHeight||document.documentElement.clientHeight||document.body.clientHeight;t.current.width=a*n,t.current.height=r*n,h((function(e){return Object.assign({},e,{aspect:r/a})}))};window.addEventListener("resize",a),a()}}),[t,x]),r.a.createElement("div",null,r.a.createElement("canvas",{ref:t,className:"canvas",width:640}))},D={networkId:"testnet",nodeUrl:"https://rpc.testnet.near.org",archivalNodeUrl:"https://rpc.mainnet.internal.near.org",contractName:"dev-1633114897352-65032726804099",walletUrl:"https://wallet.testnet.near.org"},P=function(e){Object(h.a)(n,e);var t=Object(v.a)(n);function n(e){var a;return Object(d.a)(this,n),(a=t.call(this,e))._near={},a._near.lsKey=D.contractName+":v01:",a._near.lsKeyRecentCards=a._near.lsKey+"recentCards",a.state={connected:!1,draw:!1,isNavCollapsed:!0,account:null,requests:null,recentCards:m.a.get(a._near.lsKeyRecentCards)||[]},a._initNear().then((function(){a.setState({signedIn:!!a._near.accountId,signedAccountId:a._near.accountId,connected:!0})})),a}return Object(f.a)(n,[{key:"_initNear",value:function(){var e=Object(l.a)(u.a.mark((function e(){var t,n;return u.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=new b.keyStores.BrowserLocalStorageKeyStore,e.next=3,b.connect(Object.assign({deps:{keyStore:t}},D));case 3:n=e.sent,this._near.archivalConnection=b.Connection.fromConfig({networkId:D.networkId,provider:{type:"JsonRpcProvider",args:{url:D.archivalNodeUrl}},signer:{type:"InMemorySigner",keyStore:t}}),this._near.keyStore=t,this._near.near=n,this._near.walletConnection=new b.WalletConnection(n,D.contractName),this._near.accountId=this._near.walletConnection.getAccountId(),this._near.account=this._near.walletConnection.account(),this._near.berryclub=new b.Account(this._near.archivalConnection,"berryclub.ek.near"),this._near.contract=new b.Contract(this._near.account,D.contractName,{viewMethods:["get_cells_json","get_storage_balance"],changeMethods:["draw_json"]});case 12:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"requestSignIn",value:function(){var e=Object(l.a)(u.a.mark((function e(t){return u.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t&&t.preventDefault(),"",e.next=4,this._near.walletConnection.requestSignIn(D.contractName,"");case 4:return e.abrupt("return",!1);case 5:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"logOut",value:function(){var e=Object(l.a)(u.a.mark((function e(){return u.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:this._near.walletConnection.signOut(),this._near.accountId=null,this.setState({signedIn:!!this._accountId,signedAccountId:this._accountId});case 3:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"popRequest",value:function(e){var t=this.state.requests.slice(1);this.setState({requests:t},e)}},{key:"addRequest",value:function(e,t){var n=this.state.requests.slice(0);n.push(e),this.setState({requests:n},t)}},{key:"addRecentCard",value:function(e){var t=this.state.recentCards.slice(0),n=t.indexOf(e);-1!==n&&t.splice(n,1),t.unshift(e),t=t.slice(0,5),m.a.set(this._near.lsKeyRecentCards,t),this.setState({recentCards:t})}},{key:"refreshAllowance",value:function(){var e=Object(l.a)(u.a.mark((function e(){return u.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return alert("You're out of access key allowance. Need sign in again to refresh it"),e.next=3,this.logOut();case 3:return e.next=5,this.requestSignIn();case 5:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"render",value:function(){var e=this,t=Object(i.a)({_near:this._near,updateState:function(t,n){return e.setState(t,n)},popRequest:function(t){return e.popRequest(t)},addRequest:function(t,n){return e.addRequest(t,n)},addRecentCard:function(t){return e.addRecentCard(t)},refreshAllowance:function(){return e.refreshAllowance()}},this.state),n=this.state.connected?this.state.signedIn?r.a.createElement("div",null,r.a.createElement("button",{onClick:function(){return e.setState({draw:!e.state.draw})}},this.state.draw?"Draw mode":"Scroll mode"),r.a.createElement("button",{className:"btn btn-outline-secondary",style:{float:"right"},onClick:function(){return e.logOut()}},"Sign out (",this.state.signedAccountId,")")):r.a.createElement("div",null,r.a.createElement("button",{className:"btn btn-primary",onClick:function(t){return e.requestSignIn(t)}},"Sign in with NEAR Wallet")):r.a.createElement("div",null,"Connecting... ",r.a.createElement("span",{className:"spinner-grow spinner-grow-sm",role:"status","aria-hidden":"true"}));return r.a.createElement("div",{className:"App"},n,r.a.createElement("a",{className:"github-fork-ribbon right-bottom fixed",href:"https://github.com/evgenykuzyakov/hexland","data-ribbon":"Fork me on GitHub",title:"Fork me on GitHub"},"Fork me on GitHub"),r.a.createElement(M,t))}}]),n}(r.a.Component);c.a.render(r.a.createElement(P,null),document.getElementById("root"))},88:function(e,t,n){e.exports=n(171)},93:function(e,t,n){}},[[88,1,2]]]);
//# sourceMappingURL=main.97aea1aa.chunk.js.map