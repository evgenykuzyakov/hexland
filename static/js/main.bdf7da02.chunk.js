(this.webpackJsonpfrontend=this.webpackJsonpfrontend||[]).push([[0],{111:function(e,t,n){},112:function(e,t,n){},117:function(e,t){},125:function(e,t){},141:function(e,t){},143:function(e,t){},172:function(e,t,n){"use strict";n.r(t);var r=n(2),a=n.n(r),i=n(84),c=n.n(i),o=(n(94),n(87)),s=n(0),u=n.n(s),l=n(9),d=n(32),h=n(33),f=n(88),v=n(85),p=(n(47),n(111),n(112),n(15)),m=n(45),g=n.n(m),b=n(10),x=n(86),w=n(24),y=n.n(w),_={},k=Math.pow(16,5),C=k/2,S=k/2,R={level:3,x:C/Math.pow(16,4),y:S/Math.pow(16,4)},E=y()(10).pow(23),O=y()(100).mul(y()(10).pow(12)).toFixed(0),I=function(e){return"#".concat((16777215&e).toString(16).padStart(6,"0"))},j=function(e){return JSON.stringify(e)},q=function(e){return{x:Math.trunc(e.x/16),y:Math.trunc(e.y/16),level:0}},z=function(){function e(t,n,r){Object(d.a)(this,e),this.contract=t,this.ctx=n,this.redraw=r,this.pixelQueue=[],this.pendingPixels=[],this.pending={},this.sendQueueTimer=null,this.numFailedTxs=0,this.needRedraw=!1}return Object(h.a)(e,[{key:"fetchCells",value:function(){var e=Object(l.a)(u.a.mark((function e(t){var n;return u.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.contract.get_cells_json({cell_ids:t});case 2:return n=e.sent,e.abrupt("return",t.reduce((function(e,t,r){return e[j(t)]=n[r],e}),{}));case 4:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"getCell",value:function(e){var t=j(e);return t in _?_[t]:{nonce:0,colors:new Array(256).fill(0)}}},{key:"setCell",value:function(e,t){_[j(e)]=t}},{key:"internalPaint",value:function(e,t){if(!(j(e)in _)){var n=Math.pow(16,e.level+1),r=e.x*n-C,a=e.y*n-S;this.ctx.fillStyle=I(t),this.ctx.fillRect(r,a,n,n),this.needRedraw=!0}}},{key:"internalRender",value:function(e,t){for(var n=this.ctx.createImageData(16,16),r=n.data,a=0,i=0;i<16;++i)for(var c=0;c<16;++c){var o=16*i+c,s=t.colors[o];r[a++]=s>>16&255,r[a++]=s>>8&255,r[a++]=255&s,r[a++]=255}var u=Math.pow(16,e.level+1),l=e.x*u-C,d=e.y*u-S;this.ctx.putImageData(n,l,d),this.needRedraw=!0}},{key:"internalRedraw",value:function(){this.needRedraw&&(this.needRedraw=!1,this.redraw())}},{key:"sendQueue",value:function(){var e=Object(l.a)(u.a.mark((function e(){var t,n,r=this;return u.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.pixelQueue.sort((function(e,t){return j(q(e)).localeCompare(j(q(t)))})),t=this.pixelQueue.splice(0,100),this.pendingPixels=t,e.t0=y.a,e.next=6,this.contract.get_storage_balance({account_id:this.contract.account.accountId});case 6:if(e.t1=e.sent,e.t1){e.next=9;break}e.t1="0";case 9:return e.t2=e.t1,n=(0,e.t0)(e.t2),e.prev=11,e.next=14,this.contract.draw_json({pixels:t},O,n.lt(E)?"1000000000000000000000000":"0");case 14:this.numFailedTxs=0,e.next=27;break;case 17:if(e.prev=17,e.t3=e.catch(11),-1===e.t3.toString().indexOf("does not have enough balance")){e.next=24;break}return e.next=23,this.refreshAllowance();case 23:return e.abrupt("return");case 24:console.log("Failed to send a transaction",e.t3),this.numFailedTxs+=1,this.numFailedTxs<3?(this.pixelQueue=this.pixelQueue.concat(this.pendingPixels),this.pendingPixels=[]):(this.pendingPixels=[],this.pixelQueue=[]);case 27:this.pendingPixels.forEach((function(e){return delete r.pending[j(e)]})),this.pendingPixels=[];case 29:case"end":return e.stop()}}),e,this,[[11,17]])})));return function(){return e.apply(this,arguments)}}()},{key:"pingQueue",value:function(){var e=Object(l.a)(u.a.mark((function e(t){var n=this;return u.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.sendQueueTimer&&(clearTimeout(this.sendQueueTimer),this.sendQueueTimer=null),0!==this.pendingPixels.length||!(this.pixelQueue.length>=100||t)){e.next=4;break}return e.next=4,this.sendQueue();case 4:this.pixelQueue.length>0&&(this.sendQueueTimer=setTimeout(Object(l.a)(u.a.mark((function e(){return u.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,n.pingQueue(!0);case 2:case"end":return e.stop()}}),e)}))),250));case 5:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"modifyPixel",value:function(e){var t=this,n=q(e),r=this.getCell(n),a=16*(e.y-16*n.y)+e.x-16*n.x;r.colors[a]=e.c;var i=e.x-C,c=e.y-S;this.ctx.fillStyle=I(e.c),this.ctx.fillRect(i,c,1,1),this.needRedraw=!0,setTimeout((function(){t.internalRedraw()}),100)}},{key:"draw",value:function(e){var t={x:C+e.a,y:S+e.b,c:16777215},n=j(t);n in this.pending||(this.pending[n]=!0,this.pixelQueue.push(t),this.modifyPixel(t)),this.pingQueue(!1)}},{key:"refreshCells",value:function(){var e=Object(l.a)(u.a.mark((function e(){var t,n,r,a=this;return u.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t=[R];case 1:if(!(t.length>0)){e.next=10;break}return n=t.splice(0,16),e.next=5,this.fetchCells(n);case 5:r=e.sent,Object.entries(r).forEach((function(e){var n,r=Object(x.a)(e,2),i=r[0],c=r[1];if(c){if(n=i,0===(i=JSON.parse(n)).level)a.internalRender(i,c);else{var o=a.getCell(i);if(c.nonce!==o.nonce)for(var s=0;s<16;++s)for(var u=0;u<16;++u){var l=16*s+u;if(c.colors[l]!==o.colors[l]){var d={level:i.level-1,x:16*i.x+u,y:16*i.y+s};a.internalPaint(d,c.colors[l]),t.push(d)}}}a.setCell(i,c)}})),this.internalRedraw(),e.next=1;break;case 10:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()}]),e}(),P=Math.sqrt(3)/2,N=2*P,A=P,Q=null,T=!1,M={a:0,b:0,zoom:1,aspect:1};function F(e,t){var n=t/1.5;return{a:(e-n*A)/N,b:n}}var D=function(e){var t=Object(r.useRef)(null),n=e._near.contract,i=e.draw;return Object(r.useEffect)((function(){T=i}),[i]),Object(r.useEffect)((function(){if(t.current&&n){console.log("Setup");var e=t.current.getContext("webgl"),r=function(){var e=Object(l.a)(u.a.mark((function e(t){var n,r,i,c,o,s,l,d,h,f,v,p;return u.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:for(i=function(e,t){var a=1.5*(t-r)+0*(e-n),i=(t-r)*A+(e-n)*N;return i*i+a*a},n=2048*(M.a+t.a/M.zoom+.5)-.5,r=2048*(M.b+t.b/M.zoom+.5)-.5,c=Math.trunc(n),o=Math.trunc(r),s=null,l=10,d=-1;d<2;++d)for(h=-1;h<2;++h)(p=i(f=c+d,v=o+h))<l+1e-9&&(s={a:f,b:v},l=p);a.draw(s);case 9:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),a=function(e,t){var n=b.createProgramInfo(t,["\nconst float Sq3 = sqrt(3.0) / 2.0;\nconst mat2 D = mat2(Sq3 * 2.0, Sq3, 0.0, -1.5);\n\nuniform vec2 resolution;\nuniform vec3 pos;\n\nattribute vec4 a_position;\nattribute vec2 a_texcoord;\nattribute vec2 a_ab;\n\nvarying vec2 v_texCoord;\nvarying vec2 v_ab;\n\nvoid main() {\n  gl_Position = vec4((a_position.xy - pos.xy * D) * vec2(2.0, 2.0 * resolution.x / resolution.y) * pos.z, a_position.zw);\n  v_texCoord = a_texcoord;\n  v_ab = a_ab;\n}\n","\nprecision highp float;\n\nconst float Sq3 = sqrt(3.0) / 2.0;\nconst mat2 D = mat2(Sq3 * 2.0, Sq3, 0.0, -1.5);\n\nuniform vec3 color;\nuniform sampler2D u_diffuse;\nuniform vec2 texSize;\n\nvarying vec2 v_texCoord;\nvarying vec2 v_ab;\n\nfloat d(vec2 p) {\n  vec2 dx = (p - v_ab) * D;\n  return dot(dx, dx);\n}\n\nvec3 mind(vec3 a, vec2 b)\n{\n  float db = d(b); \n  return mix(vec3(b, db), a, step(a.z, db));\n}\n\nvoid main() {\n  vec2 fab = floor(v_ab);\n  vec3 best = vec3(fab, d(fab));\n  best = mind(best, fab + vec2(1.0, 0.0));\n  best = mind(best, fab + vec2(0.0, 1.0));\n  best = mind(best, fab + vec2(1.0, 1.0));\n  \n  vec4 diffuseColor = texture2D(u_diffuse, best.xy / texSize);\n  if (diffuseColor.w < 1.0) {\n    discard;\n  }\n  gl_FragColor = diffuseColor;\n}\n"]),r={a_position:[-P-P/2,.75,0,P-P/2,.75,0,0-P/2,-.75,0,P-P/2,.75,0,2*P-P/2,-.75,0,0-P/2,-.75,0],a_texcoord:[0,0,1,0,0,1,1,0,1,1,0,1],a_ab:{numComponents:2,data:[-.5,-.5,2047.5,-.5,-.5,2047.5,2047.5,-.5,2047.5,2047.5,-.5,2047.5]}},a=b.createBufferInfoFromArrays(t,r),i=document.createElement("canvas");i.width=2048,i.height=2048;var c=i.getContext("2d");c.clearRect(0,0,2048,2048);var o=b.createTextures(t,{fromCanvas:{src:i,mag:t.NEAREST,min:t.NEAREST,wrap:t.CLAMP_TO_EDGE}}),s=new z(e,c,(function(){c.fillStyle="rgba(0, 0, 0, 0)",c.fillRect(0,0,1,1),b.setTextureFromElement(t,o.fromCanvas,i)}));return s.refreshCells(),setInterval((function(){s.refreshCells()}),5e3),requestAnimationFrame((function e(r){b.resizeCanvasToDisplaySize(t.canvas),b.bindFramebufferInfo(t,null),t.viewport(0,0,t.canvas.width,t.canvas.height);var i={resolution:[t.canvas.width,t.canvas.height],texSize:[2047,2047],pos:[M.a,M.b,M.zoom],u_diffuse:o.fromCanvas};t.useProgram(n.program),b.setBuffersAndAttributes(t,n,a),b.setUniforms(n,i),b.drawBufferInfo(t,a),requestAnimationFrame(e)})),s}(n,e);t.current.addEventListener("mousemove",(function(e){var t=e.clientX,n=e.clientY,a=e.target.getBoundingClientRect(),i=F((t-a.x)/a.width-.5,(n-a.y)/a.width-a.height/a.width*.5);if(1&e.buttons&&T)r(i);else if(Q&&!T){var c=F((t-Q.x)/a.width,(n-Q.y)/a.width),o=c.a,s=c.b;M={a:M.a-o/M.zoom,b:M.b-s/M.zoom,zoom:M.zoom,aspect:M.aspect}}Q=1&e.buttons?{x:t,y:n}:null})),t.current.addEventListener("mousedown",(function(e){if(1&e.buttons&&T){var t=e.clientX,n=e.clientY,a=e.target.getBoundingClientRect(),i=(t-a.x)/a.width-.5,c=(n-a.y)/a.width-a.height/a.width*.5;r(F(i,c))}})),t.current.addEventListener("wheel",(function(e){e.preventDefault();var t=e.target.getBoundingClientRect(),n=(e.clientX-t.x)/t.width-.5,r=((e.clientY-t.y)/t.width-t.height/t.width*.5)/1.5,a=(n-r*A)/N,i=Math.max(1/64,M.zoom*Math.exp(.001*-e.deltaY)),c=M.a+a/M.zoom,o=M.b+r/M.zoom;M={a:c-a/i,b:o-r/i,zoom:i,aspect:M.aspect}}));var i=function(){var n=(window.devicePixelRatio||1)/(e.webkitBackingStorePixelRatio||e.mozBackingStorePixelRatio||e.msBackingStorePixelRatio||e.oBackingStorePixelRatio||e.backingStorePixelRatio||1),r=window.innerWidth||document.documentElement.clientWidth||document.body.clientWidth,a=window.innerHeight||document.documentElement.clientHeight||document.body.clientHeight;t.current.width=r*n,t.current.height=a*n,M=Object.assign({},M,{aspect:a/r})};window.addEventListener("resize",i),i()}}),[t,n]),a.a.createElement("div",null,a.a.createElement("canvas",{ref:t,className:"canvas",width:640}))},B={networkId:"testnet",nodeUrl:"https://rpc.testnet.near.org",archivalNodeUrl:"https://rpc.mainnet.internal.near.org",contractName:"dev-1633114897352-65032726804099",walletUrl:"https://wallet.testnet.near.org"},H=function(e){Object(f.a)(n,e);var t=Object(v.a)(n);function n(e){var r;return Object(d.a)(this,n),(r=t.call(this,e))._near={},r._near.lsKey=B.contractName+":v01:",r._near.lsKeyRecentCards=r._near.lsKey+"recentCards",r.state={connected:!1,draw:!1,isNavCollapsed:!0,account:null,requests:null,recentCards:g.a.get(r._near.lsKeyRecentCards)||[]},r._initNear().then((function(){r.setState({signedIn:!!r._near.accountId,signedAccountId:r._near.accountId,connected:!0})})),r}return Object(h.a)(n,[{key:"_initNear",value:function(){var e=Object(l.a)(u.a.mark((function e(){var t,n;return u.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=new p.keyStores.BrowserLocalStorageKeyStore,e.next=3,p.connect(Object.assign({deps:{keyStore:t}},B));case 3:n=e.sent,this._near.archivalConnection=p.Connection.fromConfig({networkId:B.networkId,provider:{type:"JsonRpcProvider",args:{url:B.archivalNodeUrl}},signer:{type:"InMemorySigner",keyStore:t}}),this._near.keyStore=t,this._near.near=n,this._near.walletConnection=new p.WalletConnection(n,B.contractName),this._near.accountId=this._near.walletConnection.getAccountId(),this._near.account=this._near.walletConnection.account(),this._near.berryclub=new p.Account(this._near.archivalConnection,"berryclub.ek.near"),this._near.contract=new p.Contract(this._near.account,B.contractName,{viewMethods:["get_cells_json","get_storage_balance"],changeMethods:["draw_json"]});case 12:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"requestSignIn",value:function(){var e=Object(l.a)(u.a.mark((function e(t){return u.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t&&t.preventDefault(),"",e.next=4,this._near.walletConnection.requestSignIn(B.contractName,"");case 4:return e.abrupt("return",!1);case 5:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"logOut",value:function(){var e=Object(l.a)(u.a.mark((function e(){return u.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:this._near.walletConnection.signOut(),this._near.accountId=null,this.setState({signedIn:!!this._accountId,signedAccountId:this._accountId});case 3:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"popRequest",value:function(e){var t=this.state.requests.slice(1);this.setState({requests:t},e)}},{key:"addRequest",value:function(e,t){var n=this.state.requests.slice(0);n.push(e),this.setState({requests:n},t)}},{key:"addRecentCard",value:function(e){var t=this.state.recentCards.slice(0),n=t.indexOf(e);-1!==n&&t.splice(n,1),t.unshift(e),t=t.slice(0,5),g.a.set(this._near.lsKeyRecentCards,t),this.setState({recentCards:t})}},{key:"refreshAllowance",value:function(){var e=Object(l.a)(u.a.mark((function e(){return u.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return alert("You're out of access key allowance. Need sign in again to refresh it"),e.next=3,this.logOut();case 3:return e.next=5,this.requestSignIn();case 5:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"render",value:function(){var e=this,t=Object(o.a)({_near:this._near,updateState:function(t,n){return e.setState(t,n)},popRequest:function(t){return e.popRequest(t)},addRequest:function(t,n){return e.addRequest(t,n)},addRecentCard:function(t){return e.addRecentCard(t)},refreshAllowance:function(){return e.refreshAllowance()}},this.state),n=this.state.connected?this.state.signedIn?a.a.createElement("div",null,a.a.createElement("button",{onClick:function(){return e.setState({draw:!e.state.draw})}},this.state.draw?"Draw mode":"Scroll mode"),a.a.createElement("button",{className:"btn btn-outline-secondary",style:{float:"right"},onClick:function(){return e.logOut()}},"Sign out (",this.state.signedAccountId,")")):a.a.createElement("div",null,a.a.createElement("button",{className:"btn btn-primary",onClick:function(t){return e.requestSignIn(t)}},"Sign in with NEAR Wallet")):a.a.createElement("div",null,"Connecting... ",a.a.createElement("span",{className:"spinner-grow spinner-grow-sm",role:"status","aria-hidden":"true"}));return a.a.createElement("div",{className:"App"},n,a.a.createElement("a",{className:"github-fork-ribbon right-bottom fixed",href:"https://github.com/evgenykuzyakov/hexland","data-ribbon":"Fork me on GitHub",title:"Fork me on GitHub"},"Fork me on GitHub"),a.a.createElement(D,t))}}]),n}(a.a.Component);c.a.render(a.a.createElement(H,null),document.getElementById("root"))},89:function(e,t,n){e.exports=n(172)},94:function(e,t,n){}},[[89,1,2]]]);
//# sourceMappingURL=main.bdf7da02.chunk.js.map